# Implementation Plan: Phase IV â€” Cloud-Native Todo Chatbot Deployment

**Branch**: `013-todo-ai-chatbot` | **Date**: 2026-02-24 | **Spec**: user input (Phase IV brief)
**Input**: User description â€” "Phase IV: Cloud Native Todo Chatbot Deployment on Minikube"

---

## Summary

Deploy the Phase III Todo Chatbot (FastAPI backend + Next.js frontend, already implemented
with 98/98 tests passing) to a local Minikube cluster using the Agentic Dev Stack. No
Dockerfiles or Kubernetes manifests are hand-written â€” all artifacts are generated via Gordon
(docker ai), kubectl-ai, and Kagent, then packaged into a Helm chart at `charts/todo-app/`.

---

## Technical Context

**Language/Version**: Python 3.11 (backend), Node.js 18 (frontend)
**Primary Dependencies**: Docker (Gordon), kubectl-ai, Kagent, Helm 3, Minikube 1.32+
**Storage**: Neon PostgreSQL (external â€” NOT deployed to K8s; accessed via K8s Secret)
**Testing**: Kagent health analysis, `minikube service todo-frontend` browser verification
**Target Platform**: Minikube (local Kubernetes cluster, default namespace)
**Project Type**: Web application (backend + frontend as separate K8s Deployments)
**Performance Goals**: All 4 pods (2 backend + 2 frontend) reach Running/Ready within 120s of deploy
**Constraints**: `imagePullPolicy: Never` required; `eval $(minikube docker-env)` before builds; no manual YAML
**Scale/Scope**: 2 replicas each service; single Helm release; local dev only

---

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-checked after Phase 1 design.*

| Principle | Gate | Status | Notes |
|-----------|------|--------|-------|
| **I. Spec-First** | Plan exists before any Dockerfile or manifest is created | âœ… PASS | This plan precedes all implementation |
| **II. Security by Design** | Secrets in K8s Secret objects, not in values.yaml or source | âœ… PASS | `todo-backend-secret` created imperatively; never committed |
| **III. Deterministic Behavior** | All agent prompts are explicit and logged; audit trail maintained | âœ… PASS | `phase-iv-audit.log` records every delegation |
| **IV. Separation of Concerns** | Frontend, backend, secrets, and config are separate K8s resources | âœ… PASS | ClusterIP for backend, NodePort for frontend |
| **V. Reproducibility & Traceability** | `phase-iv-audit.log` + Helm chart in Git = full rebuild from source | âœ… PASS | Any developer can run `helm install` from this repo |
| **VI. API Standards** | Internal communication via K8s DNS (`http://todo-backend:8000`) | âœ… PASS | No hardcoded IPs; ClusterIP DNS used |
| **VII. AI Agent Safety** | If Gordon/kubectl-ai fails â†’ refine prompt, never manually fix | âœ… PASS | Enforced by Constitution Principle X |
| **VIII. Stateless Conversation** | Backend pods are stateless; conversation state in Neon DB | âœ… PASS | 2 replicas can serve any request |
| **IX. Agentic Infrastructure Ops** | Gordon â†’ kubectl-ai â†’ Kagent â†’ Helm workflow strictly followed | âœ… PASS | Each phase uses the designated agent |
| **X. No Manual Artifact Coding** | Zero hand-written Dockerfiles or K8s YAML | âœ… PASS | All artifacts AI-generated; audit-logged |

**All 10 gates PASS. Proceeding to Phase 0.**

---

## Project Structure

### Documentation (this feature)

```text
specs/014-cloud-native-deployment/
â”œâ”€â”€ plan.md              â† This file
â”œâ”€â”€ research.md          â† Phase 0 complete âœ…
â”œâ”€â”€ data-model.md        â† Phase 1 complete âœ… (cluster topology + resource specs)
â”œâ”€â”€ quickstart.md        â† Phase 1 complete âœ…
â”œâ”€â”€ contracts/
â”‚   â””â”€â”€ helm-values-schema.yaml   â† Phase 1 complete âœ…
â””â”€â”€ tasks.md             â† Phase 2 output (/sp.tasks â€” NOT created by /sp.plan)
```

### Source Code (repository root)

```text
charts/
â””â”€â”€ todo-app/
    â”œâ”€â”€ Chart.yaml                         # Helm chart metadata
    â”œâ”€â”€ values.yaml                        # Parameterised defaults (Helm: backend.*, frontend.*)
    â””â”€â”€ templates/
        â”œâ”€â”€ backend-deployment.yaml        # Generated by kubectl-ai
        â”œâ”€â”€ backend-service.yaml           # Generated by kubectl-ai (ClusterIP)
        â”œâ”€â”€ frontend-deployment.yaml       # Generated by kubectl-ai
        â”œâ”€â”€ frontend-service.yaml          # Generated by kubectl-ai (NodePort 30080)
        â””â”€â”€ configmap.yaml                 # todo-frontend-config

phase-iv-audit.log                         # Mandatory audit trail (one line per agent call)
Dockerfile.backend                         # Generated by Gordon (docker ai) â€” NOT hand-written
Dockerfile.frontend                        # Generated by Gordon (docker ai) â€” NOT hand-written
```

**Structure Decision**: Web application (Option 2) â€” backend and frontend as separate
top-level concerns. Infrastructure lives in `charts/` at repository root per Helm convention.

---

## Complexity Tracking

> *No constitution violations to justify â€” all 10 gates pass.*

| Potential Complexity | Why Acceptable | Simpler Alternative Rejected Because |
|----------------------|---------------|-------------------------------------|
| Two Dockerfiles | Backend (Python) and frontend (Node) require completely different base images and build processes | Single image not viable â€” different runtimes |
| K8s Secret + ConfigMap split | Secrets contain credentials; config contains non-sensitive URLs | Putting DATABASE_URL in ConfigMap would expose credentials in plaintext |

---

## Phase 0: Research Summary

All NEEDS CLARIFICATION resolved. Full rationale in `research.md`.

| Unknown | Resolution |
|---------|-----------|
| Docker base image for FastAPI | `python:3.11-slim`, 2-stage build, non-root user |
| Docker base image for Next.js | `node:18-alpine`, 3-stage build, standalone output |
| K8s manifest generation tool | `kubectl-ai` with descriptive English prompts |
| Secrets management in Minikube | K8s Secrets (imperative creation), never in values.yaml |
| Frontendâ†’Backend communication | K8s DNS (`http://todo-backend:8000`), frontend proxies to backend |
| `imagePullPolicy` setting | `Never` â€” required for Minikube local registry |
| Cluster health verification | Kagent, two passes: stability + resource right-sizing |
| Helm chart scope | Single chart (`charts/todo-app/`), both services, one `helm install` |

---

## Phase 1: Design Summary

### Cluster Topology (from `data-model.md`)

```
Minikube: default namespace
  â”œâ”€â”€ Secret: todo-backend-secret  (DATABASE_URL, OPENAI_API_KEY, BETTER_AUTH_SECRET)
  â”œâ”€â”€ ConfigMap: todo-frontend-config  (NEXT_PUBLIC_API_URL=http://todo-backend:8000)
  â”œâ”€â”€ Deployment: todo-backend  â†’ 2 pods (todo-backend:latest, Never, port 8000)
  â”œâ”€â”€ Service: todo-backend  (ClusterIP, port 8000)
  â”œâ”€â”€ Deployment: todo-frontend  â†’ 2 pods (todo-frontend:latest, Never, port 3000)
  â””â”€â”€ Service: todo-frontend  (NodePort, port 3000 â†’ 30080)
```

### Helm Values Contract (from `contracts/helm-values-schema.yaml`)

```yaml
backend:  { image, tag, replicas: 2, port: 8000, resources, livenessProbe, readinessProbe }
frontend: { image, tag, replicas: 2, port: 3000, nodePort: 30080, resources, livenessProbe, readinessProbe }
secrets:  { backendSecretName: todo-backend-secret }
configmap: { frontendConfigName: todo-frontend-config }
```

### Agent Delegation Map

| Task | Agent | Prompt Pattern |
|------|-------|---------------|
| Backend Dockerfile | Gordon (`docker ai`) | "Create multi-stage Dockerfile for FastAPI Python 3.11â€¦" |
| Frontend Dockerfile | Gordon (`docker ai`) | "Create multi-stage Dockerfile for Next.js 14 standaloneâ€¦" |
| Backend Deployment + Service | kubectl-ai | "Create Deployment for todo-backend, 2 replicas, ClusterIPâ€¦" |
| Frontend Deployment + Service | kubectl-ai | "Create Deployment + NodePort Service for todo-frontendâ€¦" |
| Post-deploy health check | Kagent | "Analyze health of all pods in default namespaceâ€¦" |
| Resource optimisation | Kagent | "Analyze CPU/memory and suggest right-sized limitsâ€¦" |

---

## Deployment Workflow (5 Phases)

### Phase 1 â€” Environment Init
1. `minikube start` + verify context
2. `eval $(minikube docker-env)` â€” switch Docker CLI to Minikube's daemon
3. Log to `phase-iv-audit.log`: `[timestamp] [ENV] minikube context activated`

### Phase 2 â€” Containerisation (Gordon)
1. Gordon generates `Dockerfile.backend` â†’ build `todo-backend:latest`
2. Gordon generates `Dockerfile.frontend` â†’ build `todo-frontend:latest`
3. Verify both images visible: `docker images | grep todo`
4. Log each Gordon call to `phase-iv-audit.log`

### Phase 3 â€” K8s Scaffolding (kubectl-ai)
1. kubectl-ai generates `backend-deployment.yaml` + `backend-service.yaml`
2. kubectl-ai generates `frontend-deployment.yaml` + `frontend-service.yaml`
3. Log each kubectl-ai call to `phase-iv-audit.log`

### Phase 4 â€” Helm Packaging
1. Organise templates into `charts/todo-app/templates/`
2. Parameterise `values.yaml` from `contracts/helm-values-schema.yaml`
3. `helm lint charts/todo-app` â€” must pass 0 failures
4. Create K8s Secret + ConfigMap (imperatively, before install)
5. `helm install todo-app charts/todo-app`

### Phase 5 â€” Verification (Kagent)
1. `kubectl get pods -w` â€” wait for 4/4 pods Running
2. Kagent Pass 1: pod stability analysis
3. Wait 2 minutes; Kagent Pass 2: resource optimisation
4. `minikube service todo-frontend` â€” browser verification
5. Log all Kagent outputs to `phase-iv-audit.log`

---

## Non-Functional Requirements

| NFR | Target | Verification |
|-----|--------|-------------|
| Pod startup time | All 4 pods Running within 120s | `kubectl get pods -w` |
| Image size (backend) | < 300MB | `docker images todo-backend` |
| Image size (frontend) | < 150MB | `docker images todo-frontend` |
| Helm lint | 0 failures | `helm lint charts/todo-app` |
| UI accessibility | Frontend reachable at `minikube service todo-frontend` | Browser test |
| Audit completeness | Every agent call logged in `phase-iv-audit.log` | Manual review |

---

## Risk Analysis

| Risk | Blast Radius | Mitigation |
|------|-------------|-----------|
| Wrong Docker context (building on host) | Images invisible to Minikube, ErrImagePull | Verify `eval $(minikube docker-env)` before every build session; check `docker ps` for Minikube containers |
| Gordon/kubectl-ai prompt fails | Blocked task | Refine prompt (add more constraints); never manually fix. Log refined prompt to audit log. |
| Neon DB unreachable from pod | Backend crashes on startup | Test `DATABASE_URL` from backend pod: `kubectl exec -it <pod> -- python -c "import asyncpg"` |

---

## Follow-up ADR Candidates

ðŸ“‹ **Architectural decision detected**: Minikube local registry vs. remote registry (DockerHub/GHCR) for image storage.
Document reasoning and tradeoffs? Run `/sp.adr minikube-image-registry-strategy`

ðŸ“‹ **Architectural decision detected**: Single Helm chart vs. separate charts per service.
Document reasoning and tradeoffs? Run `/sp.adr helm-chart-scope-single-vs-multi`
